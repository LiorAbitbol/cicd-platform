name: Deploy (ECR -> ECS)

on:
  workflow_dispatch:
  # Enable later after first successful manual deploy:
  # push:
  #   branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ACCOUNT_ID: "477153214803"   # Not secret; OK to commit
  ECR_REPO: "cicd-platform"
  ECS_CLUSTER: "cicd-pipeline-cluster"
  ECS_SERVICE: "cicd-pipeline-task-service"
  CONTAINER_NAME: "api"
  TASK_DEFINITION_FILE: "infra/ecs/task-definition.json"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/cicd-platform-github-oidc
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        id: build
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ACCOUNT_ID: ${{ env.ACCOUNT_ID }}
          ECR_REPO: ${{ env.ECR_REPO }}
        run: |
          set -euo pipefail

          IMAGE_TAG="${GITHUB_SHA}"
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
          IMAGE="${ECR_URI}:${IMAGE_TAG}"

          docker build -f docker/Dockerfile -t "${ECR_REPO}:${IMAGE_TAG}" .
          docker tag "${ECR_REPO}:${IMAGE_TAG}" "${IMAGE}"
          docker push "${IMAGE}"

          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Render task definition (inject new image)
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.TASK_DEFINITION_FILE }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build.outputs.image }}

      - name: Deploy to ECS service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.render.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
